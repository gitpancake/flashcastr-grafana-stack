ARG VERSION=v3.2.1

FROM prom/prometheus:${VERSION}

USER root

# Install envsubst (part of gettext)
RUN apk add --no-cache gettext

# Copy the template config
COPY prom.yml /etc/prometheus/prom.yml.template

# Create entrypoint script that substitutes env vars and starts prometheus
RUN echo '#!/bin/sh
envsubst < /etc/prometheus/prom.yml.template > /etc/prometheus/prom.yml
exec /bin/prometheus "$@"' > /entrypoint.sh && chmod +x /entrypoint.sh

ENTRYPOINT ["/entrypoint.sh"]
CMD ["--config.file=/etc/prometheus/prom.yml", "--storage.tsdb.path=/prometheus"]
